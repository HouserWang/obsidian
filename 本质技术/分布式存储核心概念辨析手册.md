# 分布式存储核心概念精要

## 📝 基础概念定义

### **WAL (Write-Ahead Log)**
**是什么**：一种**崩溃恢复机制**。修改数据前，先将操作记录到持久化日志中，确保系统崩溃后能恢复数据。

**核心**：先写日志，后改数据。保证数据持久性。

### **Append-Only Log**
**是什么**：一种**数据记录方式**。数据只能追加到末尾，不能修改或删除已有记录。

**核心**：只追加，不修改。保留完整历史记录。

### **State Machine Replication**
**是什么**：一种**多副本一致性方法**。多个副本从相同初始状态开始，按相同顺序执行相同操作，达到一致状态。

**核心**：相同顺序 + 相同操作 = 一致状态。

### **刷盘策略 (Flush Strategy)**
**是什么**：数据何时从内存写入磁盘的**本地持久化策略**。

- **同步刷盘**：写入后等待磁盘确认
- **异步刷盘**：写入内存后返回，后台写入磁盘

### **复制策略 (Replication Strategy)**
**是什么**：数据何时同步到其他节点的**分布式持久化策略**。

- **同步复制**：等待所有副本确认
- **异步复制**：本地成功即返回，后台同步副本

### **Write-Through**
**是什么**：一种**写入传播策略**。数据同时写入当前层级和下一层级，等待两者完成。

**核心**：同时写，等完成。保证强一致性。

### **Write-Behind**
**是什么**：一种**写入传播策略**。数据先写入当前层级并立即返回，后台异步写入下一层级。

**核心**：先返回，后台写。追求高性能。

## 🔗 核心区别与联系

| 概念 | 关注点 | 应用层级 | 与其他概念的关系 |
|------|--------|---------|----------------|
| **Append-Only Log** | **数据如何记录** | 存储层 | WAL的实现方式之一 |
| **WAL** | **如何保证不丢数据** | 持久化层 | 使用Append-Only Log记录操作 |
| **State Machine Replication** | **多副本如何一致** | 分布式层 | 依赖Append-Only Log记录操作序列 |
| **刷盘策略** | **内存到磁盘的时机** | 本地持久化 | 实现WAL的具体机制 |
| **复制策略** | **本地到远程的时机** | 分布式持久化 | State Machine Replication的实现机制 |
| **Write-Through** | **分层写入的同步性** | 抽象模式 | 同步刷盘/复制的模式描述 |
| **Write-Behind** | **分层写入的异步性** | 抽象模式 | 异步刷盘/复制的模式描述 |

## 🎯 一句话区分

- **Append-Only Log**：日志只能追加，不能修改
- **WAL**：先写日志，再改数据（防崩溃）
- **State Machine Replication**：多副本按相同顺序执行操作
- **刷盘策略**：内存数据何时写入磁盘
- **复制策略**：本地数据何时同步到其他节点
- **Write-Through**：同时写入两级存储，等待完成
- **Write-Behind**：先写入当前层，后台写下一层

## 🔄 层级关系

```
操作执行层: State Machine Replication (保证多副本一致)
    ↓
日志记录层: Append-Only Log (记录操作序列)
    ↓
持久化层: WAL (保证日志不丢失)
    ↓
实现机制: 刷盘策略(本地) + 复制策略(远程)
    ↓
设计模式: Write-Through / Write-Behind (描述传播策略)
```

## 💡 核心联系

1. **WAL** 通常使用 **Append-Only Log** 方式实现
2. **State Machine Replication** 依赖 **Append-Only Log** 记录操作序列
3. **刷盘策略** 是 **WAL** 的具体实现机制
4. **复制策略** 是 **State Machine Replication** 的具体实现机制
5. **Write-Through/Write-Behind** 是描述刷盘和复制策略的**抽象模式**

**简单记忆**：
- **记录方式** → Append-Only Log
- **崩溃恢复** → WAL
- **多副本一致** → State Machine Replication
- **实现机制** → 刷盘 + 复制
- **设计模式** → Write-Through/Write-Behind